
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>客服监控 </title>
    <link rel="stylesheet" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" href="../../css/layui.css">
    <!--引入wangEditor.css-->
    <link href="../../summernote.css" rel="stylesheet"/>
    <link rel="stylesheet" href="../../css/mystyle.css">
    <script src="../../js/common.js"></script>
    <style>
        #tabinfo_ct td {
            font-size: 14px;
            color: #666;
            height: 28px;
        }
        #clk_hdpic_ct_hd {
            box-shadow: 0px 0px 14px rgba(255, 102, 0, 0.3);
        }
        #clk_hdpic_ct a.chghdpic {
            display: block;
            color: #4FB910;
            border: 1px solid #4FB910;
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
            width: 60px;
            height: 18px;
            line-height: 18px;
            background-color: #fff;
        }
        #tabinfo_ct td.tabinfo_ct_val {
            color: #444;
        }
        #edit_cpinfo {
            display: inline-block;
            color: #4FB910;
            border: 1px solid #4FB910;
            margin-left: 8px;
            width: 38px;
            height: 18px;
            line-height: 18px;
            cursor: pointer;
            color: #4FB910;
            border-radius: 10px;
            text-align: center;
        }
        .mynavi {
            padding: 25px;
            padding-bottom: 10px;
            padding-top: 20px;
            background: #FAFCFF;
        }
        .mynavi ul,.mynavi ul li {
            padding: 0px;
            margin: 0px;
        }

        .mynavi ul {
            width: 751px;
            height: 45px;
            overflow: hidden;
            background: url('../../images/hui_1.jpg');
            position: relative
        }
        .mynavi ul li {
            width: 158px;
            height: 100%;
            position: absolute;
            top: 0px;
            cursor: pointer;
        }
        .mynavi ul li.nav_1 {
            left: 0px;
            background: url(../../images/an_1.jpg)
        }
        .mynavi ul li.nav_2 {
            left: 150px;
        }
        .mynavi ul li.nav_3 {
            left: 300px;
        }
        .mynavi ul li.nav_4 {
            left: 450px;
        }
        .mynavi ul li.nav_5 {
            left: 600px;
        }
        .checkbox, .radio {
            margin: 0;
        }
        .help_info {
            display: none;
        }
    </style>
</head>
<body class="layui-layout-body">
    <div class="layui-side layui-bg-black">
        <h2 class="side_bar_nav_title">客服监控</h2>
        <div class="layui-side-scroll">
            <ul class="layui-nav layui-nav-tree"  lay-filter="test">
                <li class="layui-nav-item layui-nav-itemed">
                    <a class="" href="javascript:;">客服监控</a>
                    <dl class="layui-nav-child">
                        <dd data-index="0" class="layui-this"><a href="javascript:;">客服团队</a></dd>
                        <dd data-index="1"><a href="javascript:;">评价设置</a></dd>
                        <dd data-index="2"><a href="javascript:;">评价记录</a></dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>
    <div class="layui-body">
        <!-- 客服团队 -->
        <div class="nav_tab_item">
            <div class="location">您当前的位置：CC客服 &gt; <span>客服监控</span> &gt; <span>客服团队</span></div>
            <form class="layui-form"> 
                <div class="layui-form-item layerui_wrap">
                    <div class="layui-inline">
                        时间：
                    </div>
                    <div class="layui-inline layui-inline1">
                        <input type="text" class="layui-input" id="startTime">
                    </div>
                    <div class="layui-inline">
                        至
                    </div>
                    <div class="layui-inline layui-inline1">
                        <input type="text" class="layui-input" id="endTime">
                    </div>
                    <div class="layui-inline">
                        客服组
                    </div>
                    <div class="layui-inline layui-inline1">
                        <select name="city" lay-verify="">
                          <option value="">不限</option>
                        </select>
                    </div>
                    <div class="layui-inline">
                        客服人员
                    </div>
                    <div class="layui-inline layui-inline1">
                        <select name="city" lay-verify="">
                          <option value="">不限</option>
                        </select>
                    </div>
                    <div class="layui-inline layui-inline1">
                        <input type="button" value="查询" class="button2 seachBtn">
                    </div>
                </div>
            </form>
            <table class="layui-table" lay-skin="line" lay-size="sm" style="text-align:center">
                <thead style="text-align:center">
                    <tr>
                        <th>日期</th>
                        <th>客服人员</th>
                        <th>现时状态</th>
                        <th>已接待访客数</th>
                        <th>正在接待访客数 </th>
                        <th>沟通总时长</th>
                        <th>对话情况</th>
                    </tr> 
                </thead>
                <tbody id="fkTable">
                    <!--<tr>-->
                        <!--<td>2018-02-24</td>-->
                        <!--<td>超级管理员</td>-->
                        <!--<td>离线</td>-->
                        <!--<td>0</td>-->
                        <!--<td>0</td>-->
                        <!--<td>0</td>-->
                        <!--<td>0</td>-->
                    <!--</tr>-->
                </tbody>
            </table> 
        </div>
         <!-- 评价设置 -->
        <div class="nav_tab_item none">
            <div class="location">
                您当前的位置：CC客服 &gt; <span>客服监控</span> &gt; <span>评价设置</span>
            </div>
            <div class="ser_invite_view_left" style="width:100%">
                <form action="index.php?c=ClerkCommentSet&amp;a=saveSet" method="post" id="saveform">
                    <input type="hidden" name="website" value="133299">
                    <div class="eval_set_box">
                        <p class="pjia"> 客服评价：
                            <input name="enable" type="radio" value="1"> 启用&nbsp;&nbsp;&nbsp; 
                            <input checked="" name="enable" type="radio" value="0"> 禁用<br>
                        </p>
                        <p class="tongz">差评通知：
                            <input checked="" name="isnotice" type="radio" value="1"> 启用&nbsp;&nbsp;&nbsp; 
                            <input name="isnotice" type="radio" value="0"> 禁用
                        </p>
                        <div class="eval_set_box_s2">
                            <p>警示分值：
                                <select name="noticelevel" id="noticelevel">
                                    <option value="1">恶劣(1分)</option>
                                    <option value="2" selected="">比较差(2分)</option>
                                    <option value="3">一般(3分)</option>
                                    <option value="4">比较满意(4分)</option>
                                    <option value="5">非常满意(5分)</option>
                                </select>
                                <img class="ck_helptips" data-html="当访客的评价低于或等于设置的警示分值时，系统会及时的通知相关人员。" data-offset="3" data-position="bottom right" data-variation="inverted" style="cursor:pointer" src="../../images/tjyw.gif">
                            </p>
                            <p class="mt5">
                                通知对象： 
                                <label id="noticenums">1</label>人&nbsp;&nbsp;<span id="add_user" style="cursor: pointer;"><img src="../../images/ico_add_user.gif" style="vertical-align:-3px"> 添加</span>
                            </p>
                            <table border="0" id="tableName" cellspacing="0" cellpadding="0" class="eval_set_box_s2_tab" width="100%" style="table-layout:fixed">
                                <tbody>
                                    <tr rel="1">
                                        <td width="45%" class="firsttd">
                                            <div>
                                                <img src="../../images/sex2_3.gif"><input type="hidden" name="userid[]" value="1955861">超级管理员(CC2292391)
                                            </div>
                                            <div>
                                                <img src="../../images/sex2_3.gif"><input type="hidden" name="userid[]" value="1955861">超级管理员(CC2292391)
                                            </div>
                                        </td>
                                        <td width="15%">
                                            <input disabled="" class="sxinput" type="checkbox" name="sendsms" value="1"> 短信 <img src="../../images/phone_n.gif" title="没有绑定手机或者手机未验证" class="nomobile">
                                        </td>
                                        <td width="15%">
                                            <input type="checkbox" class="sxinput" name="sendemail" value="1"> 邮件 <img src="../../images/email_s.gif">
                                        </td>
                                        <td width="15%">
                                            <input checked="" class="sxinput" type="checkbox" name="sendCC" value="1"> CC消息
                                        </td>
                                        <td width="10%">
                                            <a onclick="return false;" href="" rel="1" id="1" class="deluser">删除</a>&nbsp;
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p style="padding-left:82px; color:#666; line-height:28px;display:none;">
                            <span class="fc_red">提示：企业短信模块已停用。</span>
                            <a href="javascript:;" class=" fc_12">启用企业短信模块</a>&nbsp;&nbsp;&nbsp; 可用短信数量：
                            <span class="fc_red">
                                <strong>0</strong>
                            </span>　
                            <a href="" class="fc_12" target="_blank" style="border-bottom:none">购买&gt;&gt;</a>
                        </p>
                        <div style="padding:5px 82px">
                            <input type="button" id="saveEvaluate" value="保存设置" class="button2">&nbsp;&nbsp;
                        </div>
                        <div class="helps">
                            <p>
                                提示：1.开启客服评价后，访客在对话过程中或对话结束后可进行服务评价。
                            </p>
                            <p style="text-indent:36px">
                                2.开启评价通知后，访客对某客服的服务评价低于设置分值时就会通过短信、邮件、CC消息的方式通知指定人员。
                            </p>
                            <p style="text-indent:36px">3.短信不可用，可能是以下原因：(1)企业短信模块已停用 (2)未验证手机。</p>
                            <p style="padding-left:36px;width:610px;">
                                3.因国家政策问题，短信运营商暂停了相关服务，导致CC客服系统中短信提醒暂时无法使用。具体恢复时间待运营商方面通知，若对您的使用造成不便，我们深表歉意！
                            </p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
         <!-- 评价记录 -->
        <div class="nav_tab_item none">
            <div class="location">
                您当前的位置：CC客服 &gt; <span>客服监控</span> &gt; <span>评价记录</span>
            </div>
            <div class="pjmsg_ts17">免费开启差评通知功能，给自己多一点机会挽留客户！&nbsp;<a target="_self" href="">立即设置</a></div>
            <form class="layui-form"> 
                <div class="layui-form-item layerui_wrap">
                    <div class="layui-inline">
                        客服组
                    </div>
                    <div class="layui-inline layui-inline1">
                        <select name="city" lay-verify="">
                          <option value="">不限</option>
                        </select> 
                    </div>
                    <div class="layui-inline">
                        客服人员
                    </div>
                    <div class="layui-inline layui-inline1">
                        <select name="city" lay-verify="">
                          <option value="">不限</option>
                        </select> 
                    </div>
                    <div class="layui-inline">
                        时间：
                    </div>
                    <div class="layui-inline layui-inline1">
                        <input type="text" class="layui-input" id="startTime1">
                    </div>
                    <div class="layui-inline">
                        至
                    </div>
                    <div class="layui-inline layui-inline1">
                        <input type="text" class="layui-input" id="endTime1">
                    </div>
                    <div class="layui-inline">
                        <input type="button" value="开始分析" class="button2 jxBtn">
                    </div>
                    <div class="layui-inline">
                        <a href="javascript:void(0);">今天</a>
                        <a href="javascript:void(0);">昨天</a>
                        <a href="javascript:void(0);">近7天</a>
                        <a href="javascript:void(0);">近30天</a>
                    </div>
                    
                </div>
            </form>
            <table class="layui-table" lay-skin="line" lay-size="sm" style="text-align:center">
                <thead style="text-align:center">
                    <tr>
                        <th>访客</th>
                        <th>接待客服</th>
                        <th>
                            <select id="level_">
                                <option value="0">评价等级</option>
                                <option value="1" selected="">恶劣</option>
                                <option value="2">比较差</option>
                                <option value="3">一般</option>
                                <option value="4">比较满意</option>
                                <option value="5">非常满意</option>
                            </select>
                        </th>
                        <th>
                            <select id="remark_">
                                <option value="0">建议内容</option>
                                <option value="1">内容非空</option>
                            </select>
                        </th>
                        <th>评价时间 </th>
                        <th>对话记录</th>
                    </tr> 
                </thead>
                <tbody id="evaluationRecor">
                    <!--<tr>-->
                        <!--<td>超级管理员</td>-->
                        <!--<td>超级管理员</td>-->
                        <!--<td>一般</td>-->
                        <!--<td>建议内容</td>-->
                        <!--<td>2017-12-12</td>-->
                        <!--<td>0</td>-->
                    <!--</tr>-->
                </tbody>
            </table> 
        </div>
    </div>
    <div class="layui-footer"></div>
    <script src="../../js/jq.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../js/layui.all.js"></script>
    <script src="../..//summernote.js"></script>
    <script src="../../lang/summernote-zh-CN.js"></script>
    <script src="../../js/myscript.js"></script>
    <script>
        var req = getQueryString();
        var companyId = req["companyId"];
        var memberId = req["memberId"];

        $(function(){
            // 客服团队列表
            getMemberList()
            function getMemberList(roleIndex) {
                var roleIndex = roleIndex || 0;
                $.ajax({
                    url: urlParam.getMemberWorkList,
                    dataType: "json",
                    xhrFields: {
                        withCredentials: true
                    },
                    // data: {
                    //     memberId: memberId
                    // },
                    crossDomain: true,
                    success: function (msg) {
                        console.log(msg);
                        if(msg.code == 0) {
                            var strHTML = "";
                            var dataArr = msg.data;
                            console.log(dataArr);
                            if(dataArr.length == 0) {
                                strHTML += "<tr><td colspan='6'>暂无记录！</td></tr>";
                                $("#fkTable").html(strHTML);
                            } else {
                                for(var i = 0; i < dataArr.length; i++) {
                                    var date = dataArr[i].update_time || "-";
                                    var no_of_admit = dataArr[i].no_of_admit || "-";  // 正在接待访客数
                                    var no_of_admited = dataArr[i].no_of_admited || "-";  // 已待访客数
                                    var status = (dataArr[i].status == 0) ? "离线" : "在线";  // 0 离线 1在线
                                    var name = dataArr[i].name || "-";      // 客服人员
                                    var timecount = dataArr[i].timecount || "-";   // 时长
                                    var conversation = dataArr[i].conversation || "-";  //回话情况
                                    strHTML +=
                                    "<tr>" +
                                        "<td>"+ date +"</td>" +
                                        "<td>"+ name +"</td>" +
                                        "<td>"+ status +"</td>" +
                                        "<td>"+ no_of_admited +"</td>" +
                                        "<td>"+ no_of_admit +"</td>" +
                                        "<td>"+ timecount +"</td>" +
                                        "<td>"+ conversation +"</td>" +
                                    "</tr>"
                                    $("#fkTable").html(strHTML);
                                }
                            }
                        } else {
                            msgMask(msg.message,1)
                        }
                    }
                })
            }
            // 日期
            layui.use('laydate', function(){
                var laydate = layui.laydate;

                // 日期控件
                laydate.render({
                    elem: '#startTime', //指定元素,
                    value: new Date()
                });
                laydate.render({
                    elem: '#endTime', //指定元素
                    value: new Date()
                });
                // 日期控件
                laydate.render({
                    elem: '#startTime1', //指定元素
                    value: new Date()
                });
                laydate.render({
                    elem: '#endTime1', //指定元素
                    value: new Date()
                });

            });

            // 获取评价
            getCommentSet();
            function getCommentSet(){
                $.ajax({
                    url: urlParam.getCommentSetting,
                    dataType: "json",
                    xhrFields: {
                        withCredentials: true
                    },
                    data: {
                        memberId: memberId
                    },
                    crossDomain: true,
                    success: function (msg) {
                        if(msg.code == 0) {
                            var dataArr = msg.object;
                            var commentable = dataArr.commentable;              // 客服评价
                            var notifiable = dataArr.notifiable;                // 是否通知
                            var level = dataArr.level;                          // 分数
                            var notify_person = dataArr.notify_person;          // 通知人员
                            var notify_way = dataArr.notify_way.split(",");     // 通知方式
                            var notify_num = notify_person.split(",");          // 通知人员人数

                            $(".pjia input[value='"+ commentable +"']").prop("checked",true);
                            $(".tongz input[value='"+ notifiable +"']").prop("checked",true);
                            $("#noticelevel").find("option[value='"+level +"']").prop("selected",true);

                            $("#noticenums").html(notify_num.length).attr("dataIds", notify_person);
                            for(var i = 0; i < notify_way.length; i ++) {
                                var thisArrVal = notify_way[i];
                                $(".sxinput").eq(thisArrVal).prop("checked",true);
                            }
                            // 获取姓名
                            getUserNameStr(notify_person);


                            console.log(commentable+ "==" + notifiable+ "=="  + level+ "=="  + notify_person + "==" + notify_way+ "=="  + notify_num);
                        } else {
                            msgMask(msg.message,1)
                        }
                    }
                })
            }

            // 评价设置
            $("#saveEvaluate").on("click", function(){
                var nofity_way = "";
                $(".sxinput").each(function(index){
                    var thisProp = $(this).prop("checked");
                    if(thisProp){
                        var thisIndex = $(this).parent().index();
                        if(index == 0) {
                            nofity_way += thisIndex;
                        } else {
                            nofity_way += "," + thisIndex;
                        }
                    }
                })
                $.ajax({
                    url: urlParam.modifyCommentSetting,
                    dataType: "json",
                    xhrFields: {
                        withCredentials: true
                    },
                    data: {
                        commentable: $(".pjia input[name=enable]:checked").val(),
                        notifiable: $(".tongz input[name=isnotice]:checked").val(),
                        level: $("#noticelevel").val(),
                        notify_person: $("#noticenums").attr("dataIds"),
                        nofity_way: nofity_way
                    },
                    crossDomain: true,
                    success: function (msg) {
                        console.log(msg);
                        if(msg.code == 0) {
                            getCommentSet()
                            msgMask("修改成功",1);
                        }
                    }
                })
            })
            var idss = [];

            // 获取个人信息
            function getUserNameStr(ids){
                $.ajax({
                    url: urlParam.getNotifies,
                    dataType: "json",
                    xhrFields: {
                        withCredentials: true
                    },
                    data: {
                        members: ids
                    },
                    crossDomain: true,
                    success: function (msg) {
                        if(msg.code == 0) {
                            var len = msg.object.length;
                            var strHTML = "";
                            if(len == 0) {
                                strHTML += "<div>暂无通知对象</div>";
                                $("#tableName .firsttd").html(strHTML);
                            } else {
                                for(var i = 0; i < len; i++) {
                                    idss.push(msg.object[i].id);
                                    strHTML += "<div id='"+ msg.object[i].id + "'><img src='../../images/sex2_3.gif'>"+ msg.object[i].name +"</div>";
                                }
                                $("#tableName .firsttd").html(strHTML);
                            }
                        } else {
                            msgMask(msg.message,1)
                        }

                    }
                })
            }

            // 评价记录 evaluationRecord
            evaluationRecordList()
            function evaluationRecordList() {
                $.ajax({
                    url: urlParam.getCommentList,
                    dataType: "json",
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (msg) {
                        console.log(msg);
                        if(msg.code == 0) {
                            var dataArr = msg.object;
                            var strHTML = "";
                            if(dataArr.length == 0) {
                                strHTML += "<tr><td colspan='6'>暂无记录！</td></tr>"
                            } else {
                                for(var i = 0; i < dataArr.length; i++ ) {
                                    var name = dataArr[i].name || "-";
                                    var jdName = dataArr[i].userName || "-";
                                    var level = dataArr[i].level || "1";
                                    var content = dataArr[i].content || "-";
                                    var conversation = dataArr[i].conversation || "-";
                                    var update_time = dataArr[i].update_time || "-";
                                    var levelStr = "";
                                    switch (level){
                                        case 1:
                                            levelStr = "恶劣";
                                            break;
                                        case 2:
                                            levelStr = "比较差";
                                            break;
                                        case 3:
                                            levelStr = "一般";
                                            break;
                                        case 4:
                                            levelStr = "比较满意";
                                            break;
                                        case 5:
                                            levelStr = "非常满意";
                                            break;
                                    }
                                    strHTML +=
                                    "<tr>" +
                                        "<td>"+ name +"</td>" +
                                        "<td>"+ jdName +"</td>" +
                                        "<td>"+ levelStr +"</td>" +
                                        "<td>"+ content +"</td>" +
                                        "<td>"+ update_time +"</td>" +
                                        "<td>"+ conversation +"</td>" +
                                    "</tr>"
                                }
                            }
                            $("#evaluationRecor").html(strHTML);
                        } else {
                            msgMask(msg.message,1)
                        }
                    }
                })
            }

            // 增加用户
            $("#add_user").on("click", function(){
                $.ajax({
                    url: urlParam.memberList,
                    dataType: "json",
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true,
                    success: function (msg) {
                        console.log(msg);
                        // 点击添加角色
                        var addRoleMaskStr = "";
                        addRoleMaskStr += '<ul class="list-group addRoleMask">';
                        for(var i = 0; i < msg.data.length; i ++){
                            addRoleMaskStr += '<li class="list-group-item" id="'+ msg.data[i].id +'"><div class="checkbox"><label><input type="checkbox">'+ msg.data[i].username +'</label>';
                        }
                        addRoleMaskStr += '</ul>';
                        var addRoleMask = parent.layer.open({
                            type: 1,
                            title:"添加通知对象",
                            area: ['370px', '350px'],
                            btn: ['确认', '取消'],
                            content: addRoleMaskStr, //这里content是一个普通的String
                            success: function(layero, index){
                                $("body",parent.document).find(".addRoleMask li").each(function(){
                                    var thisId = $(this).attr("id");
                                    for(var i = 0; i < idss.length; i++) {
                                        if(thisId == idss[i]) {
                                            $(this).find("input").prop("checked", true);
                                        }
                                    }
                                    console.log(thisId);
                                })
                            },
                            yes: function(){
                                var ids = "";
                                // $("body",parent.document).find(".addRoleMask li").each(function(index){
                                //

                                // })
                                $("body",parent.document).find(".addRoleMask li input").each(function(index){
                                    var isTrue = $(this).prop("checked");
                                    if(isTrue){
                                        var thisId = $(this).parents(".list-group-item").attr("id");
                                        if(index == 0) {
                                            ids += thisId;
                                        } else {
                                            ids += "," + thisId;
                                        }
                                    }
                                })
                                console.log(ids);
                                $.ajax({
                                    url: urlParam.memberList,
                                    dataType: "json",
                                    xhrFields: {
                                        withCredentials: true
                                    },
                                    data:{
                                        addMember: ids
                                    },
                                    crossDomain: true,
                                    success: function (msg) {
                                        console.log(msg);
                                        if(msg.code == 0) {
                                            getUserNameStr(ids)
                                            msgMask("添加成功",1);
                                            parent.layer.close(addRoleMask);
                                        } else {
                                            msgMask(msg.message,1)
                                        }
                                    }
                                })
                            },
                            btn2: function(){

                            }
                        })
                    }
                })


            })
        })



    </script>
</body>
</html>
